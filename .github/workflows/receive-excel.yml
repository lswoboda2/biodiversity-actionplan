name: Receive Excel from Drive

on:
  repository_dispatch:
    types: [new-excel-file]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google client libs
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Write Drive credentials
        run: |
          printf '%s' '${{ secrets.GDRIVE_CREDENTIALS_DATA }}' > gdrive-credentials.json
          test -s gdrive-credentials.json || (echo "ERROR: GDRIVE_CREDENTIALS_DATA is empty"; exit 1)
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/gdrive-credentials.json" >> $GITHUB_ENV

      - name: Check inputs
        run: |
          test -n "${{ github.event.client_payload.file_id }}" || (echo "ERROR: missing client_payload.file_id"; exit 1)

      - name: Download Excel by fileId -> data/source.xlsx
        env:
          FILE_ID: ${{ github.event.client_payload.file_id }}
        run: |
          mkdir -p data
          python download_from_gdrive.py "$FILE_ID" "data/source.xlsx"

      - name: Convert Excel to Parquet
        run: |
          python -m pip install pandas openpyxl pyarrow numpy
          python -c "
import pandas as pd
import numpy as np

SPECIES_COLUMNS = [
    'all', 'invertebrate', 'bat', 'mammal', 'bird', 'amphibians',
    'reptiles', 'invasive', 'plants', 'freshwater', 'coastal'
]

def clean_column_names(df: pd.DataFrame) -> pd.DataFrame:
    df.columns = [str(col).strip() for col in df.columns]
    df = df.rename(columns={
        'Priority 2025 (3 high, 1 low)': 'priority_2025',
        'Lead Contact  (provisional)': 'lead_contact',
        'Implementation ranking': 'implementation_ranking',
    })
    if 'priority_2025' in df.columns:
        df['priority_2025'] = pd.to_numeric(df['priority_2025'], errors='coerce')
    return df

print('Starting Excel to Parquet conversion...')
df = pd.read_excel('data/source.xlsx', engine='openpyxl', skiprows=1)

df = clean_column_names(df)

if 'Action' in df.columns:
    df = df.dropna(subset=['Action'])
else:
    print('WARNING: "Action" column not found.')

if 'Status' in df.columns:
    df['Status'] = df['Status'].astype(str).str.strip().str.lower().str.capitalize()
else:
    print('WARNING: "Status" column not found.')

for col in SPECIES_COLUMNS:
    if col in df.columns:
        df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0).astype(int)
    else:
        df[col] = 0

species_matrix = df[SPECIES_COLUMNS].values == 1
species_names = np.array(SPECIES_COLUMNS)
df['affected_species'] = [list(species_names[row]) for row in species_matrix]

df.to_parquet('data/source.parquet', index=False)
print('Successfully converted data/source.xlsx to data/source.parquet')
"

      - name: Commit if changed
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add data/source.xlsx data/source.parquet
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "chore: update data/source.xlsx and source.parquet from Drive"
            git push
          fi